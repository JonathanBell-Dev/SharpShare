<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SharpShare — Sign up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Minimal form styles -->
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0f172a;color:#e5e7eb}
    .container{max-width:900px;margin:0 auto;padding:1rem}
    header{border-bottom:1px solid #1f2937} .brand{color:#e5e7eb;text-decoration:none;font-weight:700}
    nav a{margin-left:1rem;color:#e5e7eb;text-decoration:none}
    .form{max-width:640px} .form label{display:block;margin:.75rem 0}
    .form input{width:100%;padding:.6rem;border:1px solid #374151;background:#0b1220;color:#e5e7eb;border-radius:.5rem}
    .primary{background:#22c55e;color:#111;padding:.5rem .8rem;border-radius:.5rem;border:0;cursor:pointer}
    .footer{border-top:1px solid #1f2937;color:#9ca3af;margin-top:2rem;padding:1rem 0}
  </style>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /*
      PURPOSE:
      - Create a new auth user with email + password.
      - Then add a row in "profiles" with their username (1:1 with auth.users).
      NOTE:
      - If your project requires email confirmation, the session may not exist
        immediately after sign-up. In that case, the upsert can fail due to RLS.
      - Your testing showed confirming the email resolves it (or disable confirmation).
    */

    // 1) Supabase project configuration
    const SUPABASE_URL = "https://qkpgnywwzisggfufwxsj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrcGdueXd3emlzZ2dmdWZ3eHNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzM5MTQsImV4cCI6MjA3OTg0OTkxNH0.-VFfjAQOgTAX8UtFVjg0KE2Nr7FYh5a0THIqL4kmqwk";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 2) A small nav specific to auth pages
    async function renderNav(){
      document.getElementById("nav").innerHTML = `
        <header>
          <div class="container" style="display:flex;justify-content:space-between;align-items:center">
            <a class="brand" href="index.html">SharpShare</a>
            <nav>
              <a href="feed.html">Feed</a>
              <a href="login.html">Login</a>
              <a href="signup.html">Sign up</a>
            </nav>
          </div>
        </header>`;
    }

    // 3) Handle sign-up + profile upsert (see note above re: email confirm)
    async function initSignup(){
      document.getElementById("signupForm").addEventListener("submit", async (e)=>{
        e.preventDefault();

        // Collect form values
        const username = document.getElementById("username").value.trim();
        const email = document.getElementById("email").value.trim();
        const pass = document.getElementById("pass").value;

        // Very basic validation
        if (username.length<3) return alert("Username must be ≥ 3 chars");

        // Create the auth user (Supabase Auth)
        const { data, error } = await sb.auth.signUp({ email, password: pass });
        if (error) return alert(error.message);

        // If a session exists right away, add/update the profile row.
        // If your project requires email confirmation, you may only get a session AFTER confirming.
        const uid = data.user?.id;
        if (uid) {
          // Insert or update the public profile row tied to this user
          const { error: upErr } = await sb.from("profiles").upsert({ id: uid, username });
          if (upErr) return alert(upErr.message);
        }

        // Go to dashboard (or prompt user to log in after confirming email)
        location.href = "dashboard.html";
      });
    }

    // 4) Initialize page
    document.addEventListener('DOMContentLoaded', async ()=>{ await renderNav(); await initSignup(); });
  </script>
</head>
<body>
  <div id="nav"></div>

  <main class="container">
    <h1>Create account</h1>

    <!-- Simple sign up form -->
    <form class="form" id="signupForm">
      <label>Username <input id="username" required minlength="3" maxlength="32" /></label>
      <label>Email <input id="email" type="email" required /></label>
      <label>Password <input id="pass" type="password" required minlength="6" /></label>
      <button class="primary" type="submit">Sign up</button>
    </form>
  </main>

  <footer class="footer"><div class="container"><small>© <span id="y"></span> SharpShare</small></div></footer>
  <script>document.getElementById('y').textContent = new Date().getFullYear();</script>
</body>
</html>
