<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SharpShare — Edit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Form + buttons styling -->
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0f172a;color:#e5e7eb}
    .container{max-width:900px;margin:0 auto;padding:1rem}
    header{border-bottom:1px solid #1f2937} .brand{color:#e5e7eb;text-decoration:none;font-weight:700}
    nav a{margin-left:1rem;color:#e5e7eb;text-decoration:none}
    .form{max-width:640px} .form label{display:block;margin:.75rem 0}
    .form input,.form textarea{width:100%;padding:.6rem;border:1px solid #374151;background:#0b1220;color:#e5e7eb;border-radius:.5rem}
    .primary{background:#22c55e;color:#111;padding:.5rem .8rem;border-radius:.5rem;border:0;cursor:pointer}
    .danger{background:#ef4444;color:#fff;padding:.5rem .8rem;border-radius:.5rem;border:0;cursor:pointer}
    .footer{border-top:1px solid #1f2937;color:#9ca3af;margin-top:2rem;padding:1rem 0}
  </style>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /*
      PURPOSE:
      - Require a logged-in user.
      - Load one post by id (from the URL ?id=...).
      - Allow the owner to update the post or delete it.
      - RLS ensures only the owner can write; client also checks for ownership.
    */

    // 1) Supabase project configuration
    const SUPABASE_URL = "https://qkpgnywwzisggfufwxsj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrcGdueXd3emlzZ2dmdWZ3eHNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzM5MTQsImV4cCI6MjA3OTg0OTkxNH0.-VFfjAQOgTAX8UtFVjg0KE2Nr7FYh5a0THIqL4kmqwk";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 2) Escape helper for safety
    function esc(s){return (s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;"," >":"&gt;",'"':"&quot;","'":"&#039;" }[m]));}

    // 3) Gate page to logged-in users
    async function requireAuth(){
      const { data:{ user } } = await sb.auth.getUser();
      if (!user){ location.replace("login.html?m=login_required"); return null; }
      return user;
    }

    // 4) Navbar for authenticated actions
    async function renderNav(){
      document.getElementById("nav").innerHTML = `
        <header>
          <div class="container" style="display:flex;justify-content:space-between;align-items:center">
            <a class="brand" href="index.html">SharpShare</a>
            <nav>
              <a href="feed.html">Feed</a>
              <a href="dashboard.html">My Posts</a>
              <a href="create.html">Create</a>
              <a href="logout.html">Logout</a>
            </nav>
          </div>
        </header>`;
    }

    // 5) Load, update, and delete logic for a single post
    async function initEdit(user){
      // Read the post id from the URL (e.g., edit.html?id=123)
      const id = Number(new URLSearchParams(location.search).get("id"));
      if (!id){ location.replace("dashboard.html"); return; }

      // Load the post from the DB
      const { data: post, error } = await sb
        .from("posts")
        .select("id,user_id,title,content")
        .eq("id", id)
        .maybeSingle();

      // Handle not found or DB errors
      if (error || !post){ alert("Post not found"); location.replace("dashboard.html"); return; }

      // Client-side owner check (defense in depth; RLS also enforces)
      if (post.user_id !== user.id){ alert("Not allowed"); location.replace("dashboard.html"); return; }

      // Put the current values into the form fields
      document.getElementById("title").value = post.title;
      document.getElementById("content").value = post.content;

      // When saving, update the row in the DB
      document.getElementById("editForm").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const title = document.getElementById("title").value.trim();
        const content = document.getElementById("content").value.trim();
        if (!title || !content) return alert("Title and content required");

        // Update; RLS ensures only the owner can perform this
        const { error } = await sb.from("posts").update({ title, content }).eq("id", id);
        if (error) return alert(error.message);

        // Back to your list
        location.href = "dashboard.html";
      });

      // When deleting, remove the row (ask for confirmation first)
      document.getElementById("delBtn").addEventListener("click", async ()=>{
        if (!confirm("Delete this post?")) return;
        const { error } = await sb.from("posts").delete().eq("id", id);
        if (error) return alert(error.message);
        location.href = "dashboard.html";
      });
    }

    // 6) Initialize page
    document.addEventListener('DOMContentLoaded', async ()=>{
      const user = await requireAuth(); if (!user) return;
      await renderNav();
      await initEdit(user);
    });
  </script>
</head>
<body>
  <div id="nav"></div>

  <main class="container">
    <h1>Edit Post</h1>

    <!-- Form for editing and deleting a post -->
    <form class="form" id="editForm">
      <label>Title <input id="title" maxlength="140" required /></label>
      <label>Content <textarea id="content" rows="6" required></textarea></label>
      <div style="display:flex;gap:.5rem;">
        <button class="primary" type="submit">Save</button>
        <button class="danger" id="delBtn" type="button">Delete</button>
      </div>
    </form>
  </main>

  <footer class="footer"><div class="container"><small>© <span id="y"></span> SharpShare</small></div></footer>
  <script>document.getElementById('y').textContent = new Date().getFullYear();</script>
</body>
</html>
